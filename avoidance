//BANKERS
#include<stdio.h>
int p,r;
int safe(int[p][r],int[p][r],int[],int[]);
void print(int[p][r],int[p][r],int[p][r],int[],int[]);
void main(){
        printf("Enter the number of processes : ");
        scanf("%d",&p);
        printf("Enter the number of resources : ");
        scanf("%d",&r);
        int alloc[p][r],need[p][r],max[p][r],avail[r],name[p],i,j,s,req[r],total[r];
        for(i=0;i<r;i++){
                printf("Enter the number of total resources of r[%d] : ",i);
                scanf("%d",&total[i]);
                avail[i]=0;
        }
        for(i=0;i<p;i++){
                 printf("Enter the process name  : ");
                 scanf("%d",&name[i]);
                 for(j=0;j<r;j++){
                         printf("Enter the number of resources of r[%d] : ",j);
                         scanf("%d",&alloc[i][j]);
                         printf("Enter the max number of resources of r[%d] : ",j);
                         scanf("%d",&max[i][j]);
                         need[i][j]=max[i][j]-alloc[i][j];
                         avail[j]=avail[j]+alloc[i][j];
                 }
        }
        for(j=0;j<r;j++){
                avail[j]=total[j]-avail[j];
                }
        printf("\n");
        print(alloc,max,need,avail,name);
        s=safe(alloc,need,avail,name);
        if(s==1){
                z:while(1){
                        int a;
                        printf("\nEnter 1 for a request : ");
                        scanf("%d",&a);
                        if(a==1){
                                printf("Enter the request on which process : ");
                                scanf("%d",&i);
                                for(j=0;j<r;j++){
                                    printf("Enter the resources r[%d] of request : ",j);
                                    scanf("%d",&req[j]);
                                    if(need[i][j]<req[j]){
                                        printf("Incorrect request\n");
                                        goto z;
                                    }
                                    avail[j]=avail[j]-req[j];
                                    alloc[i][j]=alloc[i][j]+req[j];
                                    need[i][j]=need[i][j]-req[j];
                                }
                                s=safe(alloc,need,avail,name);
                                if(s==1){
                                        printf("Request is safe and acccepted \n");
                                        print(alloc,max,need,avail,name);
                                }
                                else if(s==0){
                                        printf("The request is not safe\n");
                                        for(j=0;j<r;j++){
                                            avail[j]=avail[j]+req[j];
                                            alloc[i][j]=alloc[i][j]-req[j];
                                            need[i][j]=need[i][j]+req[j];
                                        }
                                }
                        }
                        else{
                                return;
                        }
                }
        }
}
int safe(int alloc[p][r],int need[p][r],int avail[r],int name[p]){
            int i,j,work[r],field[p],saf[p],count=0,k=0,s,flag;
            count=p;
            for(i=0;i<r;i++){
                work[i]=avail[i];
            }
            for(i=0;i<p;i++){
                field[i]=0;
            }
          l:while(count>0){
                      s=0;
                      for(i=0;i<p;i++){
                              flag=0;
                              if(field[i]!=1){
                                      for(j=0;j<r;j++){
                                              if(need[i][j]<=work[j]){
                                                      flag++;
                                              }
                                      }
                                      if(flag==r){
                                              for(j=0;j<r;j++){
                                                      work[j]=work[j]+alloc[i][j];
                                              }
                                              field[i]=1;
                                              count--;
                                              s=1;
                                              saf[k]=i;
                                              k++;
                                              goto l;
                                      }
                              }
                      }
                      if(s==0){
                              printf("Unsafe\n");
                              return 0;
                      }
              }
              if(k==p){
                    printf("\n    SAFE    \nSafe sequence : ");
                    for(i=0;i<p;i++){
                        printf("p%d\t",saf[i]);
                   }
                    return 1;
              }
}
void print(int alloc[p][r],int max[p][r],int need[p][r],int avail[r],int name[p]){
       int i,j;
       printf("\nAvailable :\t");
       for(i=0;i<r;i++){
           printf("%d\t",avail[i]);
       }
       printf("\npname\talloc\tmax\tneed\t");
       for(i=0;i<p;i++){
                    printf("\np[%d]\t",name[i]);
                for(j=0;j<r;j++){
                        printf("%d ",alloc[i][j]);
                }
                printf("\t");
                for(j=0;j<r;j++){
                        printf("%d ",max[i][j]);
                }
                printf("\t");
                for(j=0;j<r;j++){
                        printf("%d ",need[i][j]);
                }
       }
}
